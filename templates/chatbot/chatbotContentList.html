{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="{% static '/css/chatbot/chatbot2.css' %}">
    <link rel="stylesheet" href="{% static '/css/chatbot/icon.css' %}">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
    <link href="https://cdn.remixicon.com/releases/v1.2.2/remixicon.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        /* 기본 resizable 핸들 숨기기 */
        .ui-resizable-handle {
            display: none;
        }

        /* chat 요소에 커서 변경 추가 */
        #chat {


        }

        /* 커서가 chat 요소의 모서리에 위치할 때 커서 모양 변경 */
        #chat:after {
            content: "";
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
        }
    </style>
</head>
<body>
<div class="icon">
    <div class="icon__home">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 20C20 20.5523 19.5523 21 19 21H5C4.44772 21 4 20.5523 4 20V11L1 11L11.3273 1.6115C11.7087 1.26475 12.2913 1.26475 12.6727 1.6115L23 11L20 11V20ZM11 13V19H13V13H11Z"></path>
        </svg>
    </div>
    <div class="icon__account">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 22H4V20C4 17.2386 6.23858 15 9 15H15C17.7614 15 20 17.2386 20 20V22ZM12 13C8.68629 13 6 10.3137 6 7C6 3.68629 8.68629 1 12 1C15.3137 1 18 3.68629 18 7C18 10.3137 15.3137 13 12 13Z"></path>
        </svg>
    </div>
    <div class="icon__list">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 4H21V6H8V4ZM3 3.5H6V6.5H3V3.5ZM3 10.5H6V13.5H3V10.5ZM3 17.5H6V20.5H3V17.5ZM8 11H21V13H8V11ZM8 18H21V20H8V18Z"></path>
        </svg>
    </div>
    <div class="icon__log">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 4C4 3.44772 4.44772 3 5 3H10C10.5523 3 11 3.44772 11 4L11 16C11 16.5523 10.5523 17 10 17H5C4.44772 17 4 16.5523 4 16L4 4ZM14 7C13.4477 7 13 7.44772 13 8V16C13 16.5523 13.4477 17 14 17H19C19.5523 17 20 16.5523 20 16V8C20 7.44772 19.5523 7 19 7L14 7ZM21 19L3 19V21H21V19Z"></path>
        </svg>
    </div>
</div>
<input type="checkbox" name="btn" id="btn" checked>

<div class="chat-content">
    <p></p>
    <div class="buildings">
        <div class="window"></div>
        <div class="window"></div>
        <div class="window"></div>
        <div class="window"></div>
        <div class="window"></div>
        <div class="window"></div>
    </div>
    <div class="ground">
        <div class="sewer"></div>
    </div>
    <div class="streetlamp">
        <div class="base"></div>
        <div class="basetop"></div>
        <div class="pole"></div>
        <div class="poletop"></div>
        <div class="head">
            <label for="btn"></label>
            <div class="top"></div>
            <div class="glass"></div>
            <div class="bot"></div>
        </div>
        <div class="light"></div>
        <div class="ground-light"></div>
    </div>
    <div class="lamp-header"><p>Feelbuddy</p></div>
    {% if character.adminCharacter.emotion == '기쁨' %}
        <img src="/media/joy.png" alt="" class="chat-character">
    {% elif character.adminCharacter.emotion == '분노' %}
        <img src="/media/anger.png" alt="" class="chat-character">
    {% elif character.adminCharacter.emotion == '슬픔' %}
        <img src="/media/sad.png" alt="" class="chat-character">
    {% elif character.adminCharacter.emotion == '불안' %}
        <img src="/media/anxiety.png" alt="" class="chat-character">
    {% elif character.adminCharacter.emotion == '두려움' %}
        <img src="/media/fear.png" alt="" class="chat-character">
    {% endif %}
    <div class="chat-center">
        <div class="contacts">
            <i class="fas fa-bars fa-2x"></i>
            <h2>Contacts</h2>

            {% for character in characters %}
                <div class="contact">

                    {% if character.adminCharacter.emotion == '기쁨' %}

                        <div class="chat-pic joy"></div>
                        <a href="/chatbot/{{ character.id }}">
                            <div class="badge">14</div>
                            <div class="name">{{ character.name }}</div>
                            <div class="message"
                                 id="latest-message-{{ character.id }}">{{ character.last_content }}</div>
                        </a>
                    {% elif character.adminCharacter.emotion == '분노' %}

                        <div class="chat-pic anger"></div>
                        <a href="/chatbot/{{ character.id }}">
                            <div class="badge">14</div>
                            <div class="name">{{ character.name }}</div>
                            <div class="message"
                                 id="latest-message-{{ character.id }}">{{ character.last_content }}</div>
                        </a>
                    {% elif character.adminCharacter.emotion == '불안' %}
                        <div class="chat-pic anxiety"></div>
                        <a href="/chatbot/{{ character.id }}">
                            <div class="badge">14</div>
                            <div class="name">{{ character.name }}</div>
                            <div class="message"
                                 id="latest-message-{{ character.id }}">{{ character.last_content }}</div>
                        </a>
                    {% elif character.adminCharacter.emotion == '슬픔' %}
                        <div class="chat-pic sad"></div>
                        <a href="/chatbot/{{ character.id }}">
                            <div class="badge">14</div>
                            <div class="name">{{ character.name }}</div>
                            <div class="message"
                                 id="latest-message-{{ character.id }}">{{ character.last_content }}</div>
                        </a>
                    {% elif character.adminCharacter.emotion == '두려움' %}
                        <div class="chat-pic fear"></div>
                        <a href="/chatbot/{{ character.id }}">
                            <div class="badge">14</div>
                            <div class="name">{{ character.name }}</div>
                            <div class="message"
                                 id="latest-message-{{ character.id }}">{{ character.last_content }}</div>
                        </a>
                    {% endif %}

                </div>
            {% endfor %}
        </div>
        <div class="chat" id="chat">
            <div class="contact bar">
                {% if character.adminCharacter.emotion == '기쁨' %}
                    <div class="chat-pic joy"></div>
                    <div class="name">{{ character.name }}</div>
                    <div class="seen" id="latest-time-{{ character.id }}">Last at {{ last_time }}</div>
                {% elif character.adminCharacter.emotion == '분노' %}
                    <div class="chat-pic anger"></div>
                    <div class="name">{{ character.name }}</div>
                    <div class="seen" id="latest-time-{{ character.id }}">Last at {{ last_time }} </div>
                {% elif character.adminCharacter.emotion == '불안' %}
                    <div class="chat-pic anxiety"></div>
                    <div class="name">{{ character.name }}</div>
                    <div class="seen" id="latest-time-{{ character.id }}">Last at {{ last_time }}</div>
                {% elif character.adminCharacter.emotion == '슬픔' %}
                    <div class="chat-pic sad"></div>
                    <div class="name">{{ character.name }}</div>
                    <div class="seen" id="latest-time-{{ character.id }}">Last at {{ last_time }}</div>
                {% elif character.adminCharacter.emotion == '두려움' %}
                    <div class="chat-pic fear"></div>
                    <div class="name">{{ character.name }}</div>
                    <div class="seen" id="latest-time-{{ character.id }}">Last at 12:56</div>
                {% endif %}
            </div>
            <div class="messages" id="messages">

                {% for group in grouped_contents %}
                    <div class="time">{{ group.date }}</div> <!-- 날짜 표시 -->
                    {% for content in group.messages %}
                        {% if content.type == 'user' %}
                            <div class="message parker">{{ content.content }}</div>
                        {% else %}
                            <div class="message stark">{{ content.content }}</div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
            <div class="input">
                <i class="fas fa-camera"></i>
                <i class="far fa-laugh-beam"></i>
                <input type="text" id="user-content" placeholder="Type your message here!">
                <i id="record-btn" class="fas fa-microphone"></i>
            </div>
        </div>
    </div>
</div>


<script>

</script>
<script>
    $(document).ready(function () {
        function scrollChatBox() {
            $('#messages').scrollTop($('#messages')[0].scrollHeight);
        }

        // 페이지 로드 시 스크롤을 맨 아래로 이동
        scrollChatBox();

        // 엔터 키를 눌렀을 때 이벤트를 추가하기
        $('#user-content').on('keypress', function (event) {
            if (event.which === 13) { // Enter 키를 감지
                event.preventDefault(); // 기본 엔터 동작을 막기
                let userContent = $('#user-content').val();

                if (userContent.trim() !== "") {
                    // 사용자 메시지를 바로 추가하기
                    $('#messages').append(
                        `<div class="message parker">
                            ${userContent}
                        </div>`
                    );
                    $('#user-content').val('');
                    scrollChatBox();

                    // Typing 애니메이션을 추가하기
                    $('#messages').append(
                        `<div class="message stark typing">
                            <div class="typing typing-1"></div>
                            <div class="typing typing-2"></div>
                            <div class="typing typing-3"></div>
                        </div>`
                    );
                    scrollChatBox();

                    // 사용자 메시지를 서버에 전송
                    $.ajax({
                        type: 'POST',
                        url: `{% url 'chatbot:chatbot_user_create' pk=character.id %}`,
                        data: {
                            'user_content': userContent,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function () {
                            // AI 응답을 서버에 요청
                            $.ajax({
                                type: 'POST',
                                url: `{% url 'chatbot:chatbot_ai_create' pk=character.id %}`,
                                data: {
                                    'user_input': userContent,
                                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                                },
                                success: function (response) {
                                    // 2초 후에 Typing 애니메이션을 제거하고 AI 메시지를 추가
                                    setTimeout(function () {
                                        // Typing 애니메이션을 제거합니다.
                                        $('.typing').remove();

                                        // AI 메시지를 추가합니다.
                                        $('#messages').append(
                                            `<div class="message stark">
                                                ${response.ai_content}
                                            </div>`
                                        );

                                        let aiContent = response.ai_content;
                                        let truncatedContent = aiContent.length > 10 ? aiContent.slice(0, 10) + '...' : aiContent;

                                        let time = response.time1
                                        // 메시지 업데이트
                                        $('#latest-message-' + response.id2).text(truncatedContent);
                                        // 시간 업데이트
                                        $('#latest-time-' + response.id2).text('Last at ' + time);

                                        scrollChatBox();
                                    }, 2000); // 2초 딜레이
                                }
                            });
                        }
                    });
                }
            }
        });
        // Resizable 설정
        $("#chat").resizable({
            minWidth: 300,
            minHeight: 400
        });
    });
</script>
 <script>
        $(document).ready(function(){
            $('#record-btn').click(function(){
                // 알림창 표시
                alert("10초 뒤에 말씀하세요. 5초동안 말씀해주시면 됩니다.");

                // 10초 후에 녹음 시작
                setTimeout(function(){
                    $.ajax({
                        url: '{% url "chatbot:tts" %}',
                        method: 'POST',
                        headers: {'X-CSRFToken': getCookie('csrftoken')},
                        success: function(response){
                            console.log(response.text);
                            $('#user-content').val(response.text);
                        },
                        error: function(xhr, status, error){
                            console.error("오류 발생:", error);
                        }
                    });
                }, 10000); // 10초(10000ms) 후 실행
            });

            // CSRF 토큰 가져오는 함수
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    let cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>

</body>
</html>